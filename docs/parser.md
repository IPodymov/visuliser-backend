# Парсер данных (Excel Parser)

Проект включает в себя инструмент для автоматического импорта данных из Excel-файлов учебных планов.

## Структура данных

Парсер ожидает следующую структуру директорий в папке `data/`:
```
data/
├── Fit_2023/
│   ├── 03 - ... .xlsx
│   └── ...
├── Fit_2024/
│   └── ...
└── ...
```

*   **Год набора**: Определяется из названия папки (например, `Fit_2023` -> 2023).
*   **Формат файла**: `.xlsx`

### Обработка листов Excel

1.  **Лист 1 (Информация о программе)**:
    *   Считываются метаданные программы: Номер АУП, Направление, Профиль, Факультет и т.д.
    *   Программа идентифицируется по уникальному полю "Номер АУП". Если программа с таким номером уже существует, она обновляется.

2.  **Лист 2 (Дисциплины)**:
    *   Считывается список дисциплин.
    *   При повторном запуске для существующей программы старые дисциплины удаляются и заменяются новыми из файла (для предотвращения дубликатов).

## Валидация данных

При загрузке программы выполняется валидация:

*   **Номер АУП**: Обязательное поле. Если отсутствует — файл пропускается.
*   **Профиль программы**: Не может быть пустым или равным `"nan"`. При попытке загрузить программу с невалидным профилем возникает ошибка `InvalidProgramError`.

### Пример ошибки валидации
```
InvalidProgramError: Invalid profile value: 'nan'. Profile cannot be 'nan' or empty.
```

## Запуск парсера

### Через командную строку (management command)

Для массовой загрузки из папки `data/`:

```bash
python manage.py parse_excel
```

Команда выведет лог обработки каждого файла в консоль.

### Через API (для сотрудников и администраторов)

Загрузка одного файла через HTTP API:

```bash
curl -X POST http://localhost:8000/api/programs/upload/ \
  -H "Cookie: sessionid=<session_id>" \
  -F "file=@/path/to/program.xlsx" \
  -F "year=2025"
```

Подробнее см. [API Documentation](api.md#загрузка-программы-из-excel).

## Архитектура парсера

Парсер следует принципу **Single Responsibility Principle (SRP)** и разделён на два класса:

### ExcelParser
Отвечает за чтение Excel-файлов и извлечение сырых данных.

**Методы:**
*   `parse_program_data(file_path)` — парсинг метаданных программы из файла на диске
*   `parse_disciplines_data(file_path)` — парсинг дисциплин из файла на диске
*   `parse_program_data_from_file(file_obj)` — парсинг метаданных из загруженного файла
*   `parse_disciplines_data_from_file(file_obj)` — парсинг дисциплин из загруженного файла

### ProgramImporter
Отвечает за бизнес-логику импорта данных в базу.

**Методы:**
*   `import_from_file(file_path, year)` — импорт из файла на диске
*   `import_from_uploaded_file(file_obj, year)` — импорт из загруженного файла (HTTP upload)
*   `_validate_profile(profile)` — валидация профиля программы

## Исключения

*   **`InvalidProgramError`** — возникает при попытке загрузить программу с невалидными данными (например, профиль = "nan")
*   **`ValueError`** — возникает при ошибках чтения Excel-файла
